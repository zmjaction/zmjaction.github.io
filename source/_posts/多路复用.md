---
title: io -- 多路复用 理解
date: 2020-05-09 04:01:23
categories:
    - io
    - 多路复用
    - TCP/IP
tags:
    - io
    - 多路复用
    - TCP/IP

---

##### 不通过浏览器访问百度主页

```bash
exec 8<> /dev/tcp/www.baidu.com/80
# 8文件描述符 可以理解为一个对象
# <> 输入输出流
# 以读写方式打开/dev/tcp，并指定服务器名为:www.baidu.com,端口号为：80,指定描述符为8 要注意的是 /dev/tcp本身是不存在的
# /dev/tcp  类似于发出了一个socket调用，建立一个socket连接，读写这个文件就相当于在这个socket连接中传输数据
cd /proc/$$/fd
# $$ 当前解释器的进程
```

<!-- more -->

![](http://q9xxrt86m.bkt.clouddn.com/socket.jpg)







> 关闭文件描述符  exec 8<&-

以上已经创建TCP连接，剩下的就是应用层协议交互的过程

```bash
echo -e 'GET / HTTP/1.0\n' 1>& 8
cat 0<& 8
```

##### TCP描述

> 面向连接的，可靠的传输协议(确认机制)

* 面向连接（涉及到的就是三次握手），这里的连接并不是物理的，而是一个抽象的概念，三次握手之后开辟内存资源，并与上层的应用程序汇报，连接已经创建，资源的目的是为对方提供服务，

![](http://q9xxrt86m.bkt.clouddn.com/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png)

```
SYN攻击：
在三次握手过程中，Server发送SYN-ACK之后，收到Client的ACK之前的TCP连接称为半连接（half-open connect），此时Server处于SYN_RCVD状态，当收到ACK后，Server转入ESTABLISHED状态。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server回复确认包，并等待Client的确认，由于源地址是不存在的，因此，Server需要不断重发直至超时，这些伪造的SYN包将产时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络堵塞甚至系统瘫痪。SYN攻击时一种典型的DDOS攻击，检测SYN攻击的方式非常简单，即当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了，使用如下命令可以让之现行：#netstat -nap | grep SYN_RECV
```

> 四次分手 双方都想端来连接，才会释放资源

![](http://q9xxrt86m.bkt.clouddn.com/%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B.png)

在LInux中演示三次握手，四次分手

```bash
tcpdump -nn -i eth0 port 80
# -nn 不显示协议名称，直接显示IP port
# -i 抓取那块网卡的数据包
# eth0 网卡
curl www.baidu.com
```

![](http://q9xxrt86m.bkt.clouddn.com/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B%E8%BF%87%E7%A8%8B.png)

> 三次握手 ——>传输数据-->四次分手
>
> 整体可以算做一个粒度，不应该被拆散，如果做了一个负载均衡，有多台服务器，从三次握手 ——>传输数据-->四次分手 客户端只能给一个server发送

##### strace

```bash
# 终端1
strace -ff -o out nc -l 8080
 # -ff 抓取nc -l 8080 所有进程线程的对内核的调用会产生一个nc -l 8080 
 进程所对应进程id的文件如：out.92345
 # 终端2
 nc localhost 8080
 # 终端3
 tail -f out.92345 查看系统调用的过程
 ![](http://q9xxrt86m.bkt.clouddn.com/BIO%E9%98%BB%E5%A1%9E%E5%BC%8Fio.png)
```

 ![](http://q9xxrt86m.bkt.clouddn.com/strace%E7%9B%91%E6%B5%8B%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.png)



> BIO 阻塞式IO，

