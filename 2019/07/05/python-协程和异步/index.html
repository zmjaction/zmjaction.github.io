<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yijunworld.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1. 并发、并行、同步、异步、阻塞、非阻塞 并发：一个时间段内，有几个程序在同一个 CPU 上运行，但是任意时刻只有一个程序在 CPU 上运行。并行：在任意时刻点上，有多个程序同时运行在多个 CPU 上。如果 CPU 有个四颗，那么并行最多只有四个。基于以上，我们都说高并发，不说高并行。同步：指代码调用 IO 操作时，必须等待 IO 操作完成才返回的调用方式。异步：指代码调用 IO 操作时，不必等">
<meta property="og:type" content="article">
<meta property="og:title" content="python -- 协程和异步">
<meta property="og:url" content="http://yijunworld.com/2019/07/05/python-%E5%8D%8F%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/index.html">
<meta property="og:site_name" content="Action">
<meta property="og:description" content="1. 并发、并行、同步、异步、阻塞、非阻塞 并发：一个时间段内，有几个程序在同一个 CPU 上运行，但是任意时刻只有一个程序在 CPU 上运行。并行：在任意时刻点上，有多个程序同时运行在多个 CPU 上。如果 CPU 有个四颗，那么并行最多只有四个。基于以上，我们都说高并发，不说高并行。同步：指代码调用 IO 操作时，必须等待 IO 操作完成才返回的调用方式。异步：指代码调用 IO 操作时，不必等">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220170934897.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220171045861.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220170809848.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2018122017244488.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220172710413.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220173540552.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2018122017370667.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220173915308.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181220174055959.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2019-07-04T16:10:10.000Z">
<meta property="article:modified_time" content="2020-06-08T05:53:30.789Z">
<meta property="article:author" content="Action">
<meta property="article:tag" content="python">
<meta property="article:tag" content="Coroutine">
<meta property="article:tag" content="协程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20181220170934897.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="http://yijunworld.com/2019/07/05/python-%E5%8D%8F%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>python -- 协程和异步 | Action</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Action" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Action</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">锤子</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">93</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">57</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">82</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zmjaction" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yijunworld.com/2019/07/05/python-%E5%8D%8F%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cat.jpg">
      <meta itemprop="name" content="Action">
      <meta itemprop="description" content="热爱你所坚持的，坚持你所热爱的">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Action">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          python -- 协程和异步
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-05 00:10:10" itemprop="dateCreated datePublished" datetime="2019-07-05T00:10:10+08:00">2019-07-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>15 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="1-并发、并行、同步、异步、阻塞、非阻塞"><a href="#1-并发、并行、同步、异步、阻塞、非阻塞" class="headerlink" title="1. 并发、并行、同步、异步、阻塞、非阻塞"></a>1. 并发、并行、同步、异步、阻塞、非阻塞</h4><blockquote>
<p>并发：一个时间段内，有几个程序在同一个 CPU 上运行，但是任意时刻只有一个程序在 CPU 上运行。<br>并行：在任意时刻点上，有多个程序同时运行在<strong>多个 CPU </strong>上。如果 CPU 有个四颗，那么并行最多只有四个。<br>基于以上，我们都说高并发，不说高并行。<br>同步：指代码调用 IO 操作时，必须等待 IO 操作完成才返回的调用方式。<br>异步：指代码调用 IO 操作时，不必等 IO 操作完成就返回的调用方式。<br>阻塞：指调用函数时，当前线程被挂起。<br>非阻塞：指调用函数时，当前线程不会被挂起，而是立即返回。<br>阻塞和非阻塞是说的函数调用的一种机制。</p>
</blockquote>
<a id="more"></a>
<h3 id="C10k问题："><a href="#C10k问题：" class="headerlink" title="C10k问题："></a>C10k问题：</h3><blockquote>
<p>何如在一颗1Ghz CPU，2G内存，1gbps网络环境下，让单台服务器为1万个客户端提供FTP服务</p>
<p>处理用户的并发可以使用threading线程，模式来完成，但是一个线程只能处理一个socket,一个线程处理一个用户，几乎不可能完成上万用户的，如何在服务器上处理多个用户请求</p>
</blockquote>
<h3 id="2-IO-多路复用"><a href="#2-IO-多路复用" class="headerlink" title="2. IO 多路复用"></a>2. IO 多路复用</h3><h3 id="2-1-Unix-下的五种-IO-模型"><a href="#2-1-Unix-下的五种-IO-模型" class="headerlink" title="2.1 Unix 下的五种 IO 模型"></a>2.1 Unix 下的五种 IO 模型</h3><ol>
<li>阻塞式 IO</li>
<li>非阻塞式 IO</li>
<li>IO 复用</li>
<li>信号驱动式 IO</li>
<li>异步 IO （POSIX 的 aio 系列函数）</li>
</ol>
<h3 id="2-2-阻塞式-IO"><a href="#2-2-阻塞式-IO" class="headerlink" title="2.2 阻塞式 IO"></a>2.2 阻塞式 IO</h3><p><img src="https://img-blog.csdnimg.cn/20181220170934897.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>在发起 IO 请求后，当前线程会阻塞，直到响应请求。当前线程阻塞后，就会造成 CPU 等待，造成 CPU 资源浪费。</p>
</blockquote>
<h3 id="2-3-非阻塞式-IO"><a href="#2-3-非阻塞式-IO" class="headerlink" title="2.3 非阻塞式 IO"></a>2.3 非阻塞式 IO</h3><p><img src="https://img-blog.csdnimg.cn/20181220171045861.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>当发起 IO 请求后，需要不停的发起请求询问是否完成响应，通常这种询问是放在 while 循环里面完成的，但是，while 循环是非常耗费 CPU 的。而之前的阻塞式 IO 是不需要耗费 CPU，它只是当前线程被阻塞了而已。由此可知，并不是非阻塞式 IO 就比阻塞式 IO 好，实际开发中需要根据实际情况做具体分析。<br>阻塞和非阻塞 IO 方式都是调用系统级的recvfrom函数。同时，这两种模型都需要将系统地址空间中的数据报拷贝到用户地址空间。不懂的同学需要补充操作系统知识。</p>
</blockquote>
<h3 id="2-4-复用-IO"><a href="#2-4-复用-IO" class="headerlink" title="2.4 复用 IO"></a>2.4 复用 IO</h3><p><img src="https://img-blog.csdnimg.cn/20181220170809848.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>复用 IO 模型克服了非阻塞式 IO 的缺点，避免了不停发请求造成的 CPU 资源浪费。这里调用的是系统级别的 select函数，等响应完成后通知发起请求的线程。select 是一个阻塞方法，在发起请求后阻塞当前线程。 select 和使用 while 循环方式的一个很大的不同点在于：select 可以监听多个请求线程句柄。一旦其中某个线程句柄状态发生变化，就可以立即处理这个响应完成的线程。<br>但是，这种模式依然需要将数据报从系统地址空间拷贝到用户地址空间，这也需要时间。<br>这种方式使用的非常广泛。</p>
</blockquote>
<h3 id="2-5-信号驱动式-IO"><a href="#2-5-信号驱动式-IO" class="headerlink" title="2.5 信号驱动式 IO"></a>2.5 信号驱动式 IO</h3><p><img src="https://img-blog.csdnimg.cn/2018122017244488.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<blockquote>
<p>这种方式是基于信号处理的，目前使用很少。</p>
</blockquote>
</blockquote>
<h3 id="2-6-异步-IO"><a href="#2-6-异步-IO" class="headerlink" title="2.6 异步 IO"></a>2.6 异步 IO</h3><p><img src="https://img-blog.csdnimg.cn/20181220172710413.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>这种方式才是真正的异步 IO，但是这种方式并没有大规模应用，很多高并发框架也都没有采用这种方式，复用 IO 方式比较成熟，也比较稳定。并且，异步 IO 在实际使用过程中，aio_read 并没有发现有多大的提升。此外，这种方式编程难度比复用 IO 方式难。<br>这种方式省略了通知准备好数据报请求的时间。</p>
</blockquote>
<h3 id="2-7-select-poll-epoll-系统函数"><a href="#2-7-select-poll-epoll-系统函数" class="headerlink" title="2.7 select, poll, epoll 系统函数"></a>2.7 select, poll, epoll 系统函数</h3><p><img src="https://img-blog.csdnimg.cn/20181220173540552.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<p><img src="https://img-blog.csdnimg.cn/2018122017370667.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<p><img src="https://img-blog.csdnimg.cn/20181220173915308.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<blockquote>
<p>poll 和 select 一样，都需要轮询。</p>
</blockquote>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20181220174055959.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L215b25lbG90dXM=,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>epoll 只能在 Linux 中使用。epoll 使用红黑树这种数据结构进行查询，效率比较高。<br><strong>但是，并不表示 epoll 一定就比 select 好。</strong> 在并发高的情况下，连接活跃度不是很高， epoll比select好。并发性不高，同时连接很活跃， select比epoll好</p>
</blockquote>
<h3 id="3-使用非阻塞-IO-方式建立-HTTP-请求"><a href="#3-使用非阻塞-IO-方式建立-HTTP-请求" class="headerlink" title="3. 使用非阻塞 IO 方式建立 HTTP 请求"></a>3. 使用非阻塞 IO 方式建立 HTTP 请求</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过非阻塞io实现http请求</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用非阻塞io完成http请求</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment">#通过socket请求html</span></span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.netloc</span><br><span class="line">    path = url.path</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">""</span>:</span><br><span class="line">        path = <span class="string">"/"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#建立socket连接</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment"># 这一句非常重要，设置非阻塞方式，不管有没有数据准备好都是返回的</span></span><br><span class="line">    client.setblocking(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.connect((host, <span class="number">80</span>)) <span class="comment">#阻塞不会消耗cpu</span></span><br><span class="line">    <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#不停的询问连接是否建立好， 需要while循环不停的去检查状态</span></span><br><span class="line">    <span class="comment">#做计算任务或者再次发起其他的连接请求</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            client.send(<span class="string">"GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n"</span>.format(path, host).encode(<span class="string">"utf8"</span>))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = <span class="string">b""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            d = client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    data = data.decode(<span class="string">"utf8"</span>)</span><br><span class="line">    html_data = data.split(<span class="string">"\r\n\r\n"</span>)[<span class="number">1</span>]</span><br><span class="line">    print(html_data)</span><br><span class="line">    client.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    get_url(<span class="string">"http://www.baidu.com"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="4-使用多路复用-IO-方式建立网络请求"><a href="#4-使用多路复用-IO-方式建立网络请求" class="headerlink" title="4. 使用多路复用 IO 方式建立网络请求"></a>4. 使用多路复用 IO 方式建立网络请求</h3><p>&gt;</p>
<blockquote>
<p>  下面这种方式的好处是并发性高，重点掌握。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过多路复用 IO 实现http请求</span></span><br><span class="line"><span class="comment"># 实现方式：select + 回调 + 事件循环</span></span><br><span class="line"><span class="comment"># 好处是：并发性高</span></span><br><span class="line"><span class="comment"># 使用单线程</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="comment"># 通常不实用  import select，而是使用 from selectors</span></span><br><span class="line"><span class="comment"># selectors 进行了封装。DefaultSelector 封装的更好用，调用 select 方法的时候，会根据平台选择使用 epoll 还是 select。避免了 epoll 在 Windows 下不能使用的情况。</span></span><br><span class="line"><span class="comment"># 在 Linux 下使用 epoll，在 Windows 下使用 select 方法</span></span><br><span class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_READ, EVENT_WRITE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">selector = DefaultSelector()</span><br><span class="line"><span class="comment"># 使用select完成http请求</span></span><br><span class="line">urls = []</span><br><span class="line">stop = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fetcher</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connected</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="comment"># 在 send 之前，需要取消注册。</span></span><br><span class="line">        <span class="comment"># key.kd 就是 self.client.fileno() 的返回值</span></span><br><span class="line">        selector.unregister(key.fd)</span><br><span class="line">        <span class="comment"># 在这里不需要再 try/catch，因为 connected 函数在调用的时候就已经表示时间就绪了</span></span><br><span class="line">        self.client.send(<span class="string">"GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n"</span>.format(</span><br><span class="line">            self.path, self.host).encode(<span class="string">"utf8"</span>))</span><br><span class="line">        <span class="comment"># 已经发送了数据，等到响应返回，故应该是读事件</span></span><br><span class="line">        <span class="comment"># 这里是 self.readable，不是 self.readable()</span></span><br><span class="line">        selector.register(self.client.fileno(), EVENT_READ, self.readable)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readable</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="comment"># 这里读数据没有放在 While True 中</span></span><br><span class="line">        <span class="comment"># readable 函数在每次可读的时候，会被自动调用，不再需要自己不停的读</span></span><br><span class="line">        <span class="comment"># 将读完的数据放到一个外部的变量中 self.data</span></span><br><span class="line">        d = self.client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            self.data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            selector.unregister(key.fd)</span><br><span class="line">            data = self.data.decode(<span class="string">"utf8"</span>)</span><br><span class="line">            html_data = data.split(<span class="string">"\r\n\r\n"</span>)[<span class="number">1</span>]</span><br><span class="line">            print(html_data)</span><br><span class="line">            self.client.close()</span><br><span class="line">            urls.remove(self.spider_url)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> urls:</span><br><span class="line">                <span class="keyword">global</span> stop</span><br><span class="line">                stop = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_url</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        self.spider_url = url</span><br><span class="line">        url = urlparse(url)</span><br><span class="line">        self.host = url.netloc</span><br><span class="line">        self.path = url.path</span><br><span class="line">        self.data = <span class="string">b""</span></span><br><span class="line">        <span class="keyword">if</span> self.path == <span class="string">""</span>:</span><br><span class="line">            self.path = <span class="string">"/"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 建立socket连接</span></span><br><span class="line">        <span class="comment"># 这里将 client 设置为 self，因为回调函数会用到</span></span><br><span class="line">        self.client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.client.setblocking(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.connect((self.host, <span class="number">80</span>))</span><br><span class="line">        <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 注册</span></span><br><span class="line">        <span class="comment"># 第一个参数：文件描述符；第二个参数：事件；第三个：回调函数，即当事件可写的时候，执行什么函数逻辑</span></span><br><span class="line">        selector.register(self.client.fileno(), EVENT_WRITE, self.connected)</span><br><span class="line"></span><br><span class="line"><span class="comment"># loop 函数是实现的核心</span></span><br><span class="line"><span class="comment"># 回调是需要自己来做的，并不是操作系统调用回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 事件循环，不停的请求socket的状态并调用对应的回调函数</span></span><br><span class="line">    <span class="comment"># 事件循环这种模式在使用 IO 多路复用方式时会大量存在。</span></span><br><span class="line">    <span class="comment"># 1. select本身是不支持register模式。selector 对 select 进行了封装，故可以支持 register</span></span><br><span class="line">    <span class="comment"># 2. socket状态变化以后的回调是由程序员完成的</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop:</span><br><span class="line">        <span class="comment"># 这里的 stop 是全局变量</span></span><br><span class="line">        <span class="comment"># selector.select() 在 Windows 下面调用的是 select 方法，注意，当传入的列表为空时，会报错</span></span><br><span class="line">        <span class="comment"># 这也是为啥设置了一个全局 stop 变量。注意和 readable() 中的代码结合起来看，需要仔细体会。为了解决这个问题，还设置了一个 urls = [] 和 self.spider_url = url</span></span><br><span class="line">        ready = selector.select()</span><br><span class="line">        <span class="keyword">for</span> key, mask <span class="keyword">in</span> ready:</span><br><span class="line">            call_back = key.data</span><br><span class="line">            call_back(key)</span><br><span class="line">    <span class="comment"># 回调+事件循环+select(poll\epoll)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    fetcher = Fetcher()</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">"http://shop.projectsedu.com/goods/&#123;&#125;/"</span>.format(url)</span><br><span class="line">        urls.append(url)</span><br><span class="line">        fetcher = Fetcher()</span><br><span class="line">        fetcher.get_url(url)</span><br><span class="line">    loop()</span><br><span class="line">    print(time.time()-start_time)</span><br></pre></td></tr></table></figure>
<h1 id="5-协程"><a href="#5-协程" class="headerlink" title="5. 协程"></a>5. 协程</h1><h2 id="5-1-回调之痛"><a href="#5-1-回调之痛" class="headerlink" title="5.1 回调之痛"></a>5.1 回调之痛</h2><blockquote>
<p>上面的代码使用了回调，回调虽然有比较高的性能，但是有一些明显的缺点。缺点主要有以下三点：</p>
</blockquote>
<ol>
<li>可读性差；</li>
<li>共享状态管理困难；</li>
<li>异常处理困难；</li>
</ol>
<blockquote>
<p>为了解决回调的缺点，解决的办法是：</p>
</blockquote>
<ol>
<li>采用同步的方式去编写异步代码</li>
<li>使用单线程去切换任务：<ol>
<li>线程是由操作系统切换的，单线程切换意味着我们需要程序员自己去调度任务；</li>
<li>不再需要锁，并发性高，如果单线程内切换函数，性能远高于线程切换，并发性更高</li>
</ol>
</li>
</ol>
<h3 id="5-2-生成器进阶"><a href="#5-2-生成器进阶" class="headerlink" title="5.2 生成器进阶"></a>5.2 生成器进阶</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">协程，也被称作有多个入口的函数，或者可以暂停的函数（可以向暂停的地方传入值）。协程的实现方式：生成器。协程是函数级别的调用，由程序员决定自己调用逻辑。线程和进程是系统级别的调用。</span><br><span class="line">生成器：</span><br><span class="line"></span><br><span class="line">生成器不止可以产生值，还可以接收值</span><br><span class="line">下面介绍三个方法，通过这生成器中的这三个方法实现协程。</span><br></pre></td></tr></table></figure>
<h3 id="5-2-1-send-方法"><a href="#5-2-1-send-方法" class="headerlink" title="5.2.1 send 方法"></a>5.2.1 send 方法</h3><blockquote>
<p>send方法可以传递值进入生成器内部，同时还可以重启生成器执行到下一个yield位置。<br>send 方法启用生成器时，需要先 send(None)，以使生成器启用。而 next 方法不需要。<br>除了 send 方法之外，生成器启用的另一个方式是 next 方法，next(gen)。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 下面这行代码有两个作用：</span></span><br><span class="line">    <span class="comment"># 1. 可以产出值， 2. 可以接收值(调用方传递进来的值)</span></span><br><span class="line">    <span class="comment"># 在运行 html = "bobby" 和 gen.send(html) 之后，会打印 bobby，表明可以接收外面传进来的值</span></span><br><span class="line">    html = <span class="keyword">yield</span> <span class="string">"http://projectsedu.com"</span></span><br><span class="line">    print(html)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="comment"># 在调用send发送非none值之前，我们必须启动一次生成器， 方式有两种1. gen.send(None), 2. next(gen)</span></span><br><span class="line">    url = gen.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># download url</span></span><br><span class="line">    html = <span class="string">"bobby"</span></span><br><span class="line">    print(gen.send(html))  <span class="comment"># send方法可以传递值进入生成器内部，同时还可以重启生成器执行到下一个yield位置</span></span><br><span class="line">    print(gen.send(html))</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-close-方法"><a href="#5-2-2-close-方法" class="headerlink" title="5.2.2 close 方法"></a>5.2.2 close 方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 1. 可以产出值， 2. 可以接收值(调用方传递进来的值)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">"http://projectsedu.com"</span></span><br><span class="line">    <span class="comment"># GeneratorExit是继承自BaseException， 不是继承Exception</span></span><br><span class="line">    <span class="comment"># 捕捉 GeneratorExit 或者 BaseException 都会报错，捕捉 Exception 不会报错</span></span><br><span class="line">    <span class="keyword">except</span> GeneratorExit:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    print(next(gen))</span><br><span class="line">    <span class="comment"># 第一点：调用 close 方法后，如果后面的代码还有 yield 会抛出 GeneratorExit 异常。</span></span><br><span class="line">    <span class="comment"># 上面的例子中，后面有 yield 2 和 yield 3。如果注释掉这两行，close 是不会报错的。</span></span><br><span class="line">    <span class="comment"># 第二点：但是，close 之后，如果再执行 next(gen)，会抛出 StopIteration 异常。</span></span><br><span class="line">    <span class="comment"># 第三点：上面的例子，对 yield "http://projectsedu.com" 进行了 try/catch，会报 RuntimeError 异常。</span></span><br><span class="line">    <span class="comment"># 第三点：不要擅自进行 try/catch。如果 try/catch，需要在 catch 中抛出 raise StopIteration。</span></span><br><span class="line">    gen.close()</span><br><span class="line">    print(<span class="string">"bobby"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-throw-方法"><a href="#5-2-3-throw-方法" class="headerlink" title="5.2.3 throw 方法"></a>5.2.3 throw 方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#1. 可以产出值， 2. 可以接收值(调用方传递进来的值)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">"http://projectsedu.com"</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    print(next(gen))</span><br><span class="line">    <span class="comment"># 下面这一句的异常是第 4 行的异常，返回值是 2</span></span><br><span class="line">    gen.throw(Exception, <span class="string">"download error"</span>)</span><br><span class="line">    <span class="comment"># 打印值是 3</span></span><br><span class="line">    print(next(gen))</span><br><span class="line">    gen.throw(Exception, <span class="string">"download error"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-3-yield-from-语法"><a href="#5-3-yield-from-语法" class="headerlink" title="5.3 yield from 语法"></a>5.3 yield from 语法</h3><h3 id="5-3-1-yield-和-yield-from-的区别"><a href="#5-3-1-yield-和-yield-from-的区别" class="headerlink" title="5.3.1 yield 和 yield from 的区别"></a>5.3.1 yield 和 yield from 的区别</h3><blockquote>
<p>yield from 后面接一个 iterable 对象。yield from 不仅仅是不断的 yield iterable 中的值，还进行了很多额外的操作，参考源码即可。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">my_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">my_dict = &#123;</span><br><span class="line">    <span class="string">"url1"</span>: <span class="string">"http://www.baidu.com"</span>,</span><br><span class="line">    <span class="string">"url2"</span>: <span class="string">"http://www.google.com"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># for value in chain(my_list, my_dict, range(5, 10)):</span></span><br><span class="line"><span class="comment">#     print(value)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chain 内部的实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别使用yield / yield from</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_chain</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> my_iterable <span class="keyword">in</span> args:</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> my_iterable</span><br><span class="line">        <span class="comment"># for value in my_iterable:</span></span><br><span class="line">        <span class="comment">#     yield value</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> my_chain(my_list, my_dict, range(<span class="number">5</span>, <span class="number">10</span>)):</span><br><span class="line">    print(value)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g1</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g2</span><span class="params">(iterable)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> g1(range(<span class="number">10</span>)):</span><br><span class="line">    print(value)</span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> g2(range(<span class="number">10</span>)):</span><br><span class="line">    print(value)</span><br></pre></td></tr></table></figure>
<h3 id="5-3-2-yield-from-完成统计销量"><a href="#5-3-2-yield-from-完成统计销量" class="headerlink" title="5.3.2 yield from 完成统计销量"></a>5.3.2 yield from 完成统计销量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">final_result = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sales_sum</span><span class="params">(pro_name)</span>:</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    nums = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        print(pro_name+<span class="string">"销量: "</span>, x)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += x</span><br><span class="line">        nums.append(x)</span><br><span class="line">    <span class="keyword">return</span> total, nums</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">middle</span><span class="params">(key)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># sales_sum 中的返回值是两个元素，故 final_result 中的 value 是 tuple</span></span><br><span class="line">        final_result[key] = <span class="keyword">yield</span> <span class="keyword">from</span> sales_sum(key)</span><br><span class="line">        print(key+<span class="string">"销量统计完成！！."</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    data_sets = &#123;</span><br><span class="line">        <span class="string">"bobby牌面膜"</span>: [<span class="number">1200</span>, <span class="number">1500</span>, <span class="number">3000</span>],</span><br><span class="line">        <span class="string">"bobby牌手机"</span>: [<span class="number">28</span>,<span class="number">55</span>,<span class="number">98</span>,<span class="number">108</span> ],</span><br><span class="line">        <span class="string">"bobby牌大衣"</span>: [<span class="number">280</span>,<span class="number">560</span>,<span class="number">778</span>,<span class="number">70</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> key, data_set <span class="keyword">in</span> data_sets.items():</span><br><span class="line">        print(<span class="string">"start key:"</span>, key)</span><br><span class="line">        <span class="comment"># 在 middle 方法中，调用了 yield from，从而将 yield from sales_sum(key) 的返回值和 当前的 main 函数建立了双向通道 </span></span><br><span class="line">        m = middle(key)</span><br><span class="line">        m.send(<span class="literal">None</span>) <span class="comment"># 预激middle协程</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> data_set:</span><br><span class="line">            <span class="comment"># 不断地向 sales_sum 中发送值，值会被传到 x = yield 中（重点）</span></span><br><span class="line">            m.send(value)   <span class="comment"># 给协程传递每一组的值</span></span><br><span class="line">        <span class="comment"># 下面一行代码会导致 sales_sum 函数中 if not x: break，进而运行 return 语句，从而导致抛出 StopIteration</span></span><br><span class="line">        m.send(<span class="literal">None</span>)</span><br><span class="line">    print(<span class="string">"final_result:"</span>, final_result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>上面的例子，如果不使用 yield from，使用 yield 需要自己处理 StopIteration 异常。</p>
</blockquote>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">final_result = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sales_sum</span><span class="params">(pro_name)</span>:</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    nums = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        print(pro_name+<span class="string">"销量: "</span>, x)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += x</span><br><span class="line">        nums.append(x)</span><br><span class="line">    <span class="keyword">return</span> total, nums</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    my_gen = sales_sum(<span class="string">"bobby牌手机"</span>)</span><br><span class="line">    my_gen.send(<span class="literal">None</span>)</span><br><span class="line">    my_gen.send(<span class="number">1200</span>)</span><br><span class="line">    my_gen.send(<span class="number">1500</span>)</span><br><span class="line">    my_gen.send(<span class="number">3000</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 下面一行代码会导致 sales_sum 函数中 if not x: break，进而运行 return 语句，从而导致抛出 StopIteration</span></span><br><span class="line">        my_gen.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</span><br><span class="line">        result = e.value</span><br><span class="line">        print(result)</span><br></pre></td></tr></table></figure>
<h3 id="5-3-3-yield-from-深入分析"><a href="#5-3-3-yield-from-深入分析" class="headerlink" title="5.3.3 yield from 深入分析"></a>5.3.3 yield from 深入分析</h3><blockquote>
<blockquote>
<p>下面的代码非常有难度，只建议有非常扎实基础的人学习。</p>
</blockquote>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pep380</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. RESULT = yield from EXPR可以简化成下面这样</span></span><br><span class="line"><span class="comment"># 一些说明</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">_i：子生成器，同时也是一个迭代器</span></span><br><span class="line"><span class="string">_y：子生成器生产的值</span></span><br><span class="line"><span class="string">_r：yield from 表达式最终的值</span></span><br><span class="line"><span class="string">_s：调用方通过send()发送的值</span></span><br><span class="line"><span class="string">_e：异常对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">_i = iter(EXPR)      <span class="comment"># EXPR是一个可迭代对象，_i其实是子生成器；</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = next(_i)   <span class="comment"># 预激子生成器，把产出的第一个值存在_y中；</span></span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value   <span class="comment"># 如果抛出了`StopIteration`异常，那么就将异常对象的`value`属性保存到_r，这是最简单的情况的返回值；</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:    <span class="comment"># 尝试执行这个循环，委托生成器会阻塞；</span></span><br><span class="line">        _s = <span class="keyword">yield</span> _y   <span class="comment"># 生产子生成器的值，等待调用方`send()`值，发送过来的值将保存在_s中；</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _y = _i.send(_s)    <span class="comment"># 转发_s，并且尝试向下执行；</span></span><br><span class="line">        <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">            _r = _e.value       <span class="comment"># 如果子生成器抛出异常，那么就获取异常对象的`value`属性存到_r，退出循环，恢复委托生成器的运行；</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">RESULT = _r     <span class="comment"># _r就是整个yield from表达式返回的值。</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 子生成器可能只是一个迭代器，并不是一个作为协程的生成器，所以它不支持.throw()和.close()方法；</span></span><br><span class="line"><span class="string">2. 如果子生成器支持.throw()和.close()方法，但是在子生成器内部，这两个方法都会抛出异常；</span></span><br><span class="line"><span class="string">3. 调用方让子生成器自己抛出异常</span></span><br><span class="line"><span class="string">4. 当调用方使用next()或者.send(None)时，都要在子生成器上调用next()函数，当调用方使用.send()发送非 None 值时，才调用子生成器的.send()方法；</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">_i = iter(EXPR)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = next(_i)</span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _s = <span class="keyword">yield</span> _y</span><br><span class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> _e:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.close</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _m()</span><br><span class="line">            <span class="keyword">raise</span> _e</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> _e:</span><br><span class="line">            _x = sys.exc_info()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.throw</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">raise</span> _e</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    _y = _m(*_x)</span><br><span class="line">                <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                    _r = _e.value</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> _s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    _y = next(_i)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    _y = _i.send(_s)</span><br><span class="line">            <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                _r = _e.value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">RESULT = _r</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">看完代码，我们总结一下关键点：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. 子生成器生产的值，都是直接传给调用方的；调用方通过.send()发送的值都是直接传递给子生成器的；如果发送的是 None，会调用子生成器的__next__()方法，如果不是 None，会调用子生成器的.send()方法；</span></span><br><span class="line"><span class="string">2. 子生成器退出的时候，最后的return EXPR，会触发一个StopIteration(EXPR)异常；</span></span><br><span class="line"><span class="string">3. yield from表达式的值，是子生成器终止时，传递给StopIteration异常的第一个参数；</span></span><br><span class="line"><span class="string">4. 如果调用的时候出现StopIteration异常，委托生成器会恢复运行，同时其他的异常会向上 "冒泡"；</span></span><br><span class="line"><span class="string">5. 传入委托生成器的异常里，除了GeneratorExit之外，其他的所有异常全部传递给子生成器的.throw()方法；如果调用.throw()的时候出现了StopIteration异常，那么就恢复委托生成器的运行，其他的异常全部向上 "冒泡"；</span></span><br><span class="line"><span class="string">6. 如果在委托生成器上调用.close()或传入GeneratorExit异常，会调用子生成器的.close()方法，没有的话就不调用。如果在调用.close()的时候抛出了异常，那么就向上 "冒泡"，否则的话委托生成器会抛出GeneratorExit异常。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-async-和-wait-定义原生的协程"><a href="#5-4-async-和-wait-定义原生的协程" class="headerlink" title="5.4 async 和 wait 定义原生的协程"></a>5.4 async 和 wait 定义原生的协程</h3><blockquote>
<p><strong>前面是使用 yield from 实现的协程，但是这种方式过于底层。python 提供了async和await关键词用于定义原生的协程。在实际开发中，建议使用这种方式。</strong>前文的大幅章节主要用于帮助理解协程，以及协程怎么实现。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python为了将语义变得更加明确，就引入了async和await关键词用于定义原生的协程</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">downloader</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 async 中不能使用 yield</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">download_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="comment">#dosomethings</span></span><br><span class="line">    html = <span class="keyword">await</span> downloader(url)</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    coro = download_url(<span class="string">"http://www.imooc.com"</span>)</span><br><span class="line">    <span class="comment"># 不能这样调用 next(None)，应该使用下面这种方式，否则会报错</span></span><br><span class="line">    coro.send(<span class="literal">None</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>await 关键字后面只能接 Awaitable 对象。await 后面的对象不能包含 yield 关键字，即下面代码的第一种实现。当使用了 types.coroutine 装饰后，就变成了 Awaitable 对象，也就不会报错了。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="meta">@types.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"bobby"</span></span><br></pre></td></tr></table></figure>
<h3 id="5-5-生成器是有状态的"><a href="#5-5-生成器是有状态的" class="headerlink" title="5.5 生成器是有状态的"></a>5.5 生成器是有状态的</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 inspect 模块获取生成器的状态</span></span><br><span class="line"><span class="comment"># 比如：inspect.getgeneratorstate(gen)</span></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 下面这句有两层含义：</span></span><br><span class="line">    <span class="comment"># 第一：返回值给调用方； 第二： 调用方通过send方式返回值给gen</span></span><br><span class="line">    value=<span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bobby"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    print(inspect.getgeneratorstate(gen))</span><br><span class="line">    next(gen)</span><br><span class="line">    print(inspect.getgeneratorstate(gen))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        next(gen)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(inspect.getgeneratorstate(gen))</span><br></pre></td></tr></table></figure>
<h3 id="6-多路复用实现聊天群"><a href="#6-多路复用实现聊天群" class="headerlink" title="6. 多路复用实现聊天群"></a>6. 多路复用实现聊天群</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server 端</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">server select</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">g_select_timeout = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=<span class="string">'0.0.0.0'</span>, port=<span class="number">3333</span>, timeout=<span class="number">2</span>, client_nums=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.__host = host</span><br><span class="line">        self.__port = port</span><br><span class="line">        self.__timeout = timeout</span><br><span class="line">        self.__client_nums = client_nums</span><br><span class="line">        self.__buffer_size = <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">        self.server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.server.setblocking(<span class="literal">False</span>)</span><br><span class="line">        self.server.settimeout(self.__timeout)</span><br><span class="line">        self.server.setsockopt(socket.SOL_SOCKET, socket.SO_KEEPALIVE, <span class="number">1</span>)  <span class="comment"># keepalive</span></span><br><span class="line">        self.server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)  <span class="comment"># 端口复用</span></span><br><span class="line">        server_host = (self.__host, self.__port)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.server.bind(server_host)</span><br><span class="line">            self.server.listen(self.__client_nums)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        self.inputs = [self.server]  <span class="comment"># select 接收文件描述符列表</span></span><br><span class="line">        self.outputs = []  <span class="comment"># 输出文件描述符列表</span></span><br><span class="line">        self.message_queues = &#123;&#125;  <span class="comment"># 消息队列</span></span><br><span class="line">        self.client_info = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            readable, writable, exceptional = select.select(self.inputs, self.outputs, self.inputs, g_select_timeout)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (readable <span class="keyword">or</span> writable <span class="keyword">or</span> exceptional):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> readable:</span><br><span class="line">                <span class="keyword">if</span> s <span class="keyword">is</span> self.server:  <span class="comment"># 是客户端连接</span></span><br><span class="line">                    connection, client_address = s.accept()</span><br><span class="line">                    <span class="comment"># print "connection", connection</span></span><br><span class="line">                    print(<span class="string">"%s connect."</span> % str(client_address))</span><br><span class="line">                    connection.setblocking(<span class="number">0</span>)  <span class="comment"># 非阻塞</span></span><br><span class="line">                    self.inputs.append(connection)  <span class="comment"># 客户端添加到inputs</span></span><br><span class="line">                    self.client_info[connection] = str(client_address)</span><br><span class="line">                    self.message_queues[connection] = Queue()  <span class="comment"># 每个客户端一个消息队列</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:  <span class="comment"># 是client, 数据发送过来</span></span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        data = s.recv(self.__buffer_size)</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        err_msg = <span class="string">"Client Error!"</span></span><br><span class="line">                        logging.error(err_msg)</span><br><span class="line">                    <span class="keyword">if</span> data:</span><br><span class="line">                        <span class="comment"># print data</span></span><br><span class="line">                        data = <span class="string">"%s %s say: %s"</span> % (time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>), self.client_info[s], data)</span><br><span class="line">                        self.message_queues[s].put(data)  <span class="comment"># 队列添加消息</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> s <span class="keyword">not</span> <span class="keyword">in</span> self.outputs:  <span class="comment"># 要回复消息</span></span><br><span class="line">                            self.outputs.append(s)</span><br><span class="line">                    <span class="keyword">else</span>:  <span class="comment"># 客户端断开</span></span><br><span class="line">                        <span class="comment"># Interpret empty result as closed connection</span></span><br><span class="line">                        <span class="keyword">print</span></span><br><span class="line">                        <span class="string">"Client:%s Close."</span> % str(self.client_info[s])</span><br><span class="line">                        <span class="keyword">if</span> s <span class="keyword">in</span> self.outputs:</span><br><span class="line">                            self.outputs.remove(s)</span><br><span class="line">                        self.inputs.remove(s)</span><br><span class="line">                        s.close()</span><br><span class="line">                        <span class="keyword">del</span> self.message_queues[s]</span><br><span class="line">                        <span class="keyword">del</span> self.client_info[s]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> writable:  <span class="comment"># outputs 有消息就要发出去了</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    next_msg = self.message_queues[s].get_nowait()  <span class="comment"># 非阻塞获取</span></span><br><span class="line">                <span class="keyword">except</span> queue.Empty:</span><br><span class="line">                    err_msg = <span class="string">"Output Queue is Empty!"</span></span><br><span class="line">                    <span class="comment"># g_logFd.writeFormatMsg(g_logFd.LEVEL_INFO, err_msg)</span></span><br><span class="line">                    self.outputs.remove(s)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  <span class="comment"># 发送的时候客户端关闭了则会出现writable和readable同时有数据，会出现message_queues的keyerror</span></span><br><span class="line">                    err_msg = <span class="string">"Send Data Error! ErrMsg:%s"</span> % str(e)</span><br><span class="line">                    logging.error(err_msg)</span><br><span class="line">                    <span class="keyword">if</span> s <span class="keyword">in</span> self.outputs:</span><br><span class="line">                        self.outputs.remove(s)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">for</span> cli <span class="keyword">in</span> self.client_info:  <span class="comment"># 发送给其他客户端</span></span><br><span class="line">                        <span class="keyword">if</span> cli <span class="keyword">is</span> <span class="keyword">not</span> s:</span><br><span class="line">                            <span class="keyword">try</span>:</span><br><span class="line">                                cli.sendall(next_msg.encode(<span class="string">"utf8"</span>))</span><br><span class="line">                            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  <span class="comment"># 发送失败就关掉</span></span><br><span class="line">                                err_msg = <span class="string">"Send Data to %s  Error! ErrMsg:%s"</span> % (str(self.client_info[cli]), str(e))</span><br><span class="line">                                logging.error(err_msg)</span><br><span class="line">                                <span class="keyword">print</span></span><br><span class="line">                                <span class="string">"Client: %s Close Error."</span> % str(self.client_info[cli])</span><br><span class="line">                                <span class="keyword">if</span> cli <span class="keyword">in</span> self.inputs:</span><br><span class="line">                                    self.inputs.remove(cli)</span><br><span class="line">                                    cli.close()</span><br><span class="line">                                <span class="keyword">if</span> cli <span class="keyword">in</span> self.outputs:</span><br><span class="line">                                    self.outputs.remove(s)</span><br><span class="line">                                <span class="keyword">if</span> cli <span class="keyword">in</span> self.message_queues:</span><br><span class="line">                                    <span class="keyword">del</span> self.message_queues[s]</span><br><span class="line">                                <span class="keyword">del</span> self.client_info[cli]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> exceptional:</span><br><span class="line">                logging.error(<span class="string">"Client:%s Close Error."</span> % str(self.client_info[cli]))</span><br><span class="line">                <span class="keyword">if</span> s <span class="keyword">in</span> self.inputs:</span><br><span class="line">                    self.inputs.remove(s)</span><br><span class="line">                    s.close()</span><br><span class="line">                <span class="keyword">if</span> s <span class="keyword">in</span> self.outputs:</span><br><span class="line">                    self.outputs.remove(s)</span><br><span class="line">                <span class="keyword">if</span> s <span class="keyword">in</span> self.message_queues:</span><br><span class="line">                    <span class="keyword">del</span> self.message_queues[s]</span><br><span class="line">                <span class="keyword">del</span> self.client_info[s]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"__main__"</span> == __name__:</span><br><span class="line">    Server().run()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client 端</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/local/bin/python</span></span><br><span class="line"><span class="comment"># *-* coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">client.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port=<span class="number">3333</span>, timeout=<span class="number">1</span>, reconnect=<span class="number">2</span>)</span>:</span></span><br><span class="line">        self.__host = host</span><br><span class="line">        self.__port = port</span><br><span class="line">        self.__timeout = timeout</span><br><span class="line">        self.__buffer_size = <span class="number">1024</span></span><br><span class="line">        self.__flag = <span class="number">1</span></span><br><span class="line">        self.client = <span class="literal">None</span></span><br><span class="line">        self.__lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__flag</span><br><span class="line"></span><br><span class="line"><span class="meta">    @flag.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">(self, new_num)</span>:</span></span><br><span class="line">        self.__flag = new_num</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        <span class="comment"># client.bind(('0.0.0.0', 12345,))</span></span><br><span class="line">        client.setblocking(<span class="literal">True</span>)</span><br><span class="line">        client.settimeout(self.__timeout)</span><br><span class="line">        client.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)  <span class="comment"># 端口复用</span></span><br><span class="line">        server_host = (self.__host, self.__port)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            client.connect(server_host)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">return</span> client</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_msg</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.client:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">            <span class="comment"># data = raw_input()</span></span><br><span class="line">            data = sys.stdin.readline().strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"exit"</span> == data.lower():</span><br><span class="line">                <span class="keyword">with</span> self.__lock:</span><br><span class="line">                    self.flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            self.client.sendall(data.encode(<span class="string">"utf8"</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv_msg</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.client:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">with</span> self.__lock:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.flag:</span><br><span class="line">                    print(<span class="string">'ByeBye~~'</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = self.client.recv(self.__buffer_size)</span><br><span class="line">            <span class="keyword">except</span> socket.timeout:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                print(<span class="string">"%s\n"</span> % data)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.client = self.__connect()</span><br><span class="line">        send_proc = threading.Thread(target=self.send_msg)</span><br><span class="line">        recv_proc = threading.Thread(target=self.recv_msg)</span><br><span class="line">        recv_proc.start()</span><br><span class="line">        send_proc.start()</span><br><span class="line">        recv_proc.join()</span><br><span class="line">        send_proc.join()</span><br><span class="line">        self.client.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">"__main__"</span> == __name__:</span><br><span class="line">    Client(<span class="string">'localhost'</span>).run()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行方式：</span></span><br><span class="line"><span class="comment"># 1. 启动server</span></span><br><span class="line"><span class="comment"># python server.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 启动client1</span></span><br><span class="line"><span class="comment"># python client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动client2</span></span><br><span class="line"><span class="comment"># python client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在client1的console中输入任何字符串，client2中立马就可以收到</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"># python</a>
              <a href="/tags/Coroutine/" rel="tag"># Coroutine</a>
              <a href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag"># 协程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/07/03/python-Socket/" rel="prev" title="python -- socket编程">
      <i class="fa fa-chevron-left"></i> python -- socket编程
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/07/06/python-asyncio/" rel="next" title="python -- asyncio">
      python -- asyncio <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-并发、并行、同步、异步、阻塞、非阻塞"><span class="nav-number">1.</span> <span class="nav-text">1. 并发、并行、同步、异步、阻塞、非阻塞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C10k问题："><span class="nav-number"></span> <span class="nav-text">C10k问题：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-IO-多路复用"><span class="nav-number"></span> <span class="nav-text">2. IO 多路复用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Unix-下的五种-IO-模型"><span class="nav-number"></span> <span class="nav-text">2.1 Unix 下的五种 IO 模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-阻塞式-IO"><span class="nav-number"></span> <span class="nav-text">2.2 阻塞式 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-非阻塞式-IO"><span class="nav-number"></span> <span class="nav-text">2.3 非阻塞式 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-复用-IO"><span class="nav-number"></span> <span class="nav-text">2.4 复用 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-信号驱动式-IO"><span class="nav-number"></span> <span class="nav-text">2.5 信号驱动式 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-异步-IO"><span class="nav-number"></span> <span class="nav-text">2.6 异步 IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-select-poll-epoll-系统函数"><span class="nav-number"></span> <span class="nav-text">2.7 select, poll, epoll 系统函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-使用非阻塞-IO-方式建立-HTTP-请求"><span class="nav-number"></span> <span class="nav-text">3. 使用非阻塞 IO 方式建立 HTTP 请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-使用多路复用-IO-方式建立网络请求"><span class="nav-number"></span> <span class="nav-text">4. 使用多路复用 IO 方式建立网络请求</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-协程"><span class="nav-number"></span> <span class="nav-text">5. 协程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-回调之痛"><span class="nav-number"></span> <span class="nav-text">5.1 回调之痛</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-生成器进阶"><span class="nav-number"></span> <span class="nav-text">5.2 生成器进阶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-send-方法"><span class="nav-number"></span> <span class="nav-text">5.2.1 send 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-close-方法"><span class="nav-number"></span> <span class="nav-text">5.2.2 close 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-throw-方法"><span class="nav-number"></span> <span class="nav-text">5.2.3 throw 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-yield-from-语法"><span class="nav-number"></span> <span class="nav-text">5.3 yield from 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-yield-和-yield-from-的区别"><span class="nav-number"></span> <span class="nav-text">5.3.1 yield 和 yield from 的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-yield-from-完成统计销量"><span class="nav-number"></span> <span class="nav-text">5.3.2 yield from 完成统计销量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-yield-from-深入分析"><span class="nav-number"></span> <span class="nav-text">5.3.3 yield from 深入分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-async-和-wait-定义原生的协程"><span class="nav-number"></span> <span class="nav-text">5.4 async 和 wait 定义原生的协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-生成器是有状态的"><span class="nav-number"></span> <span class="nav-text">5.5 生成器是有状态的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-多路复用实现聊天群"><span class="nav-number"></span> <span class="nav-text">6. 多路复用实现聊天群</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Action"
      src="/images/cat.jpg">
  <p class="site-author-name" itemprop="name">Action</p>
  <div class="site-description" itemprop="description">热爱你所坚持的，坚持你所热爱的</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">93</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Action8686" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Action8686" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:748173631@qq.com" title="E-Mail → mailto:748173631@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">null </a>
  </div>

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Action</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">307k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:39</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

    </div>
</body>
</html>
